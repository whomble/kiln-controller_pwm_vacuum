<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>Temperature Profile</title>
 <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
 <style>
  .graph {
    width: 100%;
    height: 400px;
  }
 </style>
</head>
<body>
 <div class="container">
  <h1>Temperature Profile</h1>
  <div class="panel panel-default">
   <div class="panel-heading">
    <div class="btn-toolbar">
     <div class="btn-group">
      <button id="btn_edit" type="button" class="btn btn-default" onclick="enterEditMode()"><span class="glyphicon glyphicon-edit"></span></button>
      <button id="btn_new" type="button" class="btn btn-default" onclick="enterNewMode(selected_profile)"><span class="glyphicon glyphicon-plus"></span></button>
     </div>
     <div id="btn_controls" class="pull-right" style="margin-top: 3px">
      <div id="nav_start" class="btn-group" style="display:none">
       <button type="button" class="btn btn-default" style="visibility: hidden;" onclick="runTaskSimulation();">Simulate</button>
       <button type="button" class="btn btn-success" data-toggle="modal" data-target="#jobSummaryModal"><span class="glyphicon glyphicon-play"></span> Start</button>
      </div>
      <button id="nav_stop" type="button" class="btn btn-danger" onclick="abortTask()" style="display:none" ><span class="glyphicon glyphicon-stop"></span> Stop</button>
     </div>
     <div id="edit" style="display:none;">
      <div class="input-group">
       <span class="input-group-addon">Schedule Name</span>
       <input id="form_profile_name" type="text" class="form-control" />
       <span class="input-group-btn">
         <button class="btn btn-success" type="button" onclick="saveProfile();">Save</button>
         <button id="btn_exit" type="button" class="btn btn-default" onclick="leaveEditMode()"><span class="glyphicon glyphicon-remove"></span></button>
       </span>
      </div>
      <div class="btn-group btn-group-sm" style="margin-top: 10px">
       <button id="btn_newPoint" type="button" class="btn btn-default" onclick="newPoint()"><span class="glyphicon glyphicon-plus"></span></button>
       <button id="btn_delPoint" type="button" class="btn btn-default" onclick="delPoint()"><span class="glyphicon glyphicon-minus"></span></button>
      </div>
      <div class="btn-group btn-group-sm" style="margin-top: 10px">
       <button id="btn_table" type="button" class="btn btn-default" onclick="toggleTable()"><span class="glyphicon glyphicon-list"></span></button>
       <button id="btn_live" type="button" class="btn btn-default" onclick="toggleLive()"><span class="glyphicon glyphicon-eye-open"></span></button>
      </div>
      <div class="btn-group btn-group-sm" style="margin-top: 10px">
       <button id="btn_delProfile" type="button" class="btn btn-danger" data-toggle="modal" data-target="#delProfileModal"><span class="glyphicon glyphicon-trash"></span> Delete Profile</button>
      </div>
     </div>
    </div>
   </div>
   <div id="temperatureGraph" class="panel-body graph"></div>
   <div id="temperatureTable" class="panel-body" style="display:none;">
    <table id="temperatureTableContent" class="table table-bordered">
     <thead>
      <tr>
       <th>Time (s)</th>
       <th>Temperature (°C)</th>
       <th>Slope in °C/h</th>
      </tr>
     </thead>
     <tbody>
     </tbody>
    </table>
   </div>
  </div>

  <div id="jobSummaryModal" class="modal fade" tabindex="-1" aria-hidden="true" style="display: none;">
   <div class="modal-dialog">
    <div class="modal-content">
     <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 class="modal-title" id="jobSummaryModalLabel">Start this run?</h3>
     </div>
     <div class="modal-body">
      <table class="table table-bordered">
       <tr><td>Selected Profile</td><td><b><span id="sel_prof"></span></b></td></tr>
       <tr><td>Estimated Runtime</td><td><b><span id="sel_prof_eta"></span></b></td></tr>
       <tr><td>Estimated Power consumption</td><td><b><span id="sel_prof_cost"></span></b></td></tr>
      </table>
     </div>
     <div class="modal-footer">
      <div class="btn-group" style="width: 100%">
       <button type="button" class="btn btn-danger" style="width: 50%" data-dismiss="modal">No, take me back</button>
       <button type="button" class="btn btn-success" style="width: 50%" data-dismiss="modal" onclick="runTask()">Yes, start the Run</button>
      </div>
     </div>
    </div>
   </div>
  </div>

  <div id="delProfileModal" class="modal fade" tabindex="-1" aria-hidden="true" style="display: none;">
   <div class="modal-dialog">
    <div class="modal-content">
     <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 class="modal-title" id="delProfileModalLabel">Delete this profile?</h3>
     </div>
     <div class="modal-body">
      Do your really want to delete this profile?
     </div>
     <div class="modal-footer">
      <div class="btn-group" style="width: 100%">
       <button type="button" class="btn btn-danger" style="width: 50%" data-dismiss="modal">No, take me back</button>
       <button type="button" class="btn btn-success" style="width: 50%" data-dismiss="modal" onclick="deleteProfile()">Yes, delete the profile</button>
      </div>
     </div>
    </div>
   </div>
  </div>

  <div id="overwriteProfileModal" class="modal fade" tabindex="-1" aria-hidden="true" style="display: none;">
   <div class="modal-dialog">
    <div class="modal-content">
     <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
      <h3 class="modal-title" id="overwriteProfileModalLabel">Overwrite this profile?</h3>
     </div>
     <div class="modal-body">
      Do you want to overwrite the existing profile with the changes made?
     </div>
     <div class="modal-footer">
      <div class="btn-group" style="width: 100%">
       <button type="button" class="btn btn-danger" style="width: 50%" data-dismiss="modal">No, take me back</button>
       <button type="button" class="btn btn-success" style="width: 50%" data-dismiss="modal" onclick="saveProfile(true)">Yes, overwrite the profile</button>
      </div>
     </div>
    </div>
   </div>
  </div>
 </div>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
 <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
 <script>
  var profiles = [
    {
      name: "Profile 1",
      data: [
        [0, 20, 0],
        [30, 25, 1],
        [60, 30, 1]
      ]
    },
    {
      name: "Profile 2",
      data: [
        [0, 20, 0],
        [60, 30, 1],
        [120, 40, 2],
        [180, 25, 0.5]
      ]
    }
  ];

  var selected_profile = profiles[0];

  function enterEditMode() {
    $('#edit').show();
    $('#btn_controls').hide();
  }

  function leaveEditMode() {
    $('#edit').hide();
    $('#btn_controls').show();
  }

  function saveProfile(overwrite) {
    var profileName = $('#form_profile_name').val();
    if (profileName === "") {
      alert("Please enter a profile name.");
      return;
    }

    var profileExists = false;
    for (var i = 0; i < profiles.length; i++) {
      if (profiles[i].name === profileName) {
        if (!overwrite) {
          $('#overwriteProfileModal').modal('show');
          return;
        } else {
          profileExists = true;
          profiles[i].data = getTableData();
          break;
        }
      }
    }

    if (!profileExists) {
      var newProfile = {
        name: profileName,
        data: getTableData()
      };
      profiles.push(newProfile);
    }

    leaveEditMode();
    selected_profile = profiles.find(profile => profile.name === profileName);
    updateGraph();
  }

  function deleteProfile() {
    var profileName = selected_profile.name;
    profiles = profiles.filter(profile => profile.name !== profileName);
    selected_profile = profiles[0];
    updateGraph();
  }

  function updateGraph() {
    var data = selected_profile.data;

    var timeData = data.map(function(item) {
      return item[0];
    });

    var temperatureData = data.map(function(item) {
      return item[1];
    });

    var slopeData = data.map(function(item) {
      return item[2];
    });

    var temperatureGraph = Highcharts.chart('temperatureGraph', {
      chart: {
        type: 'spline'
      },
      title: {
        text: ''
      },
      xAxis: {
        title: {
          text: 'Time (s)'
        },
        categories: timeData
      },
      yAxis: [{
        title: {
          text: 'Temperature (°C)'
        },
        labels: {
          format: '{value}°C'
        }
      }, {
        title: {
          text: 'Slope in °C/h'
        },
        opposite: true,
        labels: {
          format: '{value}°C/h'
        }
      }],
      tooltip: {
        shared: true,
        valueSuffix: '°C'
      },
      series: [{
        name: 'Temperature',
        data: temperatureData
      }, {
        name: 'Slope',
        data: slopeData,
        yAxis: 1
      }]
    });

    var temperatureTable = $('#temperatureTableContent');
    temperatureTable.find('tbody').empty();
    for (var i = 0; i < data.length; i++) {
      var row = '<tr><td>' + data[i][0] + '</td><td>' + data[i][1] + '</td><td>' + data[i][2] + '</td></tr>';
      temperatureTable.append(row);
    }
  }

  function getTableData() {
    var tableData = [];
    $('#temperatureTableContent tbody tr').each(function() {
      var rowData = [];
      $(this).find('td').each(function() {
        rowData.push($(this).text());
      });
      tableData.push(rowData);
    });
    return tableData;
  }

  function toggleTable() {
    $('#temperatureTable').toggle();
  }

  function newPoint() {
    var tableRow = '<tr><td></td><td></td><td></td></tr>';
    $('#temperatureTableContent tbody').append(tableRow);
  }

  function delPoint() {
    $('#temperatureTableContent tbody tr:last').remove();
  }

  function toggleLive() {
    $('#temperatureGraph').toggle();
  }

  updateGraph();
 </script>
</body>
</html>
